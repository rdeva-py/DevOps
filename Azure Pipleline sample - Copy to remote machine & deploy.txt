trigger:
- main

pool:
  name: agent_name

steps:

- script: mvn clean install
  displayName: '1.Build project'

# - script: java -jar target\Christmas-0.0.1-SNAPSHOT.jar
#   displayName: 'Run application'

#Copies to local drive
- task: CopyFiles@2
  inputs:
    SourceFolder: '$(System.DefaultWorkingDirectory)\target'
    Contents: 'Christmas-0.0.1-SNAPSHOT.jar'
    TargetFolder: 'C:\Users\ruser\Downloads\$(Build.BuildNumber)'
    OverWrite: true
  displayName: '2.Copy JAR to shared folder'

#Copies to remote AWS linux machine
- script: scp -i "key.pem" "Christmas-0.0.1-SNAPSHOT.jar" user@IP_address:/home/user
  workingDirectory: 'C:\Users\ruser\Downloads'
  displayName: '3.Copy to remote machine'
  
# - script: |
#       ssh -i "key.pem" ubuntu@IP_address "PID=$(lsof -ti tcp:8080)"
#       ssh -i "key.pem" ubuntu@IP_address "kill -9 $PID" 
#   workingDirectory: 'C:\Users\ruser\Downloads'
#   displayName: '4. kill process'

- script: ssh -i "key.pem" user@IP_address "nohup java -jar deva/Christmas-0.0.1-SNAPSHOT.jar > output.log 2>&1 &"
  workingDirectory: 'C:\Users\ruser\Downloads'
  displayName: '5.deploy'